<script>

  /**
   * Contains the code executed in the sandboxed frame under web-browser
   *
   * Tries to create a Web-Worker inside the frame and set up the
   * communication between the worker and the parent window. Some
   * browsers restrict creating a worker inside a sandboxed iframe - if
   * this happens, the plugin initialized right inside the frame (in the
   * same thread)
   */


  var scripts = document.getElementsByTagName('script');
  var thisScript = scripts[scripts.length-1];
  var parentNode = thisScript.parentNode;
  var __jailed__path__ = thisScript.src
      .split('?')[0]
      .split('/')
      .slice(0, -1)
      .join('/')+'/';
  // var __pyodide__path__ = thisScript.src
  //     .split('?')[0]
  //     .split('/')
  //     .slice(0, -2)
  //     .join('/')+'/pyodide/';

  var getParamValue = function(paramName) {
      var url = window.location.search.substring(1); //get rid of "?" in querystring
      var qArray = url.split('&'); //get key-value pairs
      for (var i = 0; i < qArray.length; i++)
      {
          var pArr = qArray[i].split('='); //split key and value
          if (pArr[0] == paramName)
              return pArr[1]; //return value
      }
  }

  /**
   * Initializes the plugin inside a web worker. May throw an exception
   * in case this was not permitted by the browser.
   */
  var initWebworkerPlugin = function() {
      // creating worker as a blob enables import of local files
      var blobCode = [
        ' self.addEventListener("message", function(m){   ',
        '     if (m.data.type == "initImport") {          ',
        '         importScripts(m.data.url);              ',
        '         self.postMessage({                      ',
        '             type : "initialized",               ',
        '             dedicatedThread : true              ',
        '         });                                     ',

        '     }                                           ',
        ' });                                             ',

      ].join('\n');

      var blobUrl = window.URL.createObjectURL(
          new Blob([blobCode])
      );

      var name = getParamValue('name');
      var worker = new Worker(blobUrl, {'name' : name || 'plugin_webworker'});

      // telling worker to load _pluginWebWorker.js (see blob code above)
      worker.postMessage({
          type: 'initImport',
          url: __jailed__path__ + '_pluginWebWorker.js'
      });


      // mixed content warning in Chrome silently skips worker
      // initialization without exception, handling this with timeout
      var fallbackTimeout = setTimeout(function() {
          worker.terminate();
          initIframePlugin();
      }, 2000);

      // forwarding messages between the worker and parent window
      worker.addEventListener('message', function(m) {

          var transferables = undefined;
          if (m.data.type == 'initialized') {
              clearTimeout(fallbackTimeout);
          }
          else if(m.data.type == 'disconnect'){
            worker.terminate();
          }
          else if(m.data.type == 'message'){
            if(m.data.data.__transferables__){
              transferables = m.data.data.__transferables__;
              delete m.data.data.__transferables__;
            }
          }
          parent.postMessage(m.data, '*', transferables);
      });

      window.addEventListener('message', function(m) {
         var transferables = undefined;
         if(m.data.type == 'message'){
          if(m.data.data.__transferables__){
            transferables = m.data.data.__transferables__;
            delete m.data.data.__transferables__;
          }
        }
        worker.postMessage(m.data, transferables);
      });
  }

  /**
   * Creates plugin right in this iframe
   */
  var initWebPythonIframePlugin = function() {
      // loads additional script into the frame
      window.loadScript = function(path, sCb, fCb) {
          var script = document.createElement('script');
          script.src = path;

          var clear = function() {
              script.onload = null;
              script.onerror = null;
              script.onreadystatechange = null;
              script.parentNode.removeChild(script);
              currentErrorHandler = function(){};
          }

          var success = function() {
              clear();
              sCb();
          }

          var failure = function() {
              clear();
              fCb();
          }

          currentErrorHandler = failure;

          script.onerror = failure;
          script.onload = success;
          script.onreadystatechange = function() {
              var state = script.readyState;
              if (state==='loaded' || state==='complete') {
                  success();
              }
          }

          parentNode.appendChild(script);
      }


      // handles script loading error
      // (assuming scripts are loaded one by one in the iframe)
      var currentErrorHandler = function(){};
      window.addEventListener('error', function() {
          currentErrorHandler();
      });

      // window.loadScript(
      //     __pyodide__path__ + 'pyodide.js',
      //     function(){
      //       languagePluginLoader.then(() => {
      //         // pyodide is now ready to use...
      //         console.log(pyodide.runPython('import sys\nsys.version'));
      //       });
      //     }, function(){
      //     }
      // );

      // window.loadScript(
      //     __jailed__path__ + '_pluginWebPython.js',
      //     function(){}, function(){}
      // );
      _pluginWebPython();

  }

  /**
   * Creates plugin right in this iframe
   */
  var initIframePlugin = function() {
      // loads additional script into the frame
      window.loadScript = function(path, sCb, fCb) {
          var script = document.createElement('script');
          script.src = path;

          var clear = function() {
              script.onload = null;
              script.onerror = null;
              script.onreadystatechange = null;
              script.parentNode.removeChild(script);
              currentErrorHandler = function(){};
          }

          var success = function() {
              clear();
              sCb();
          }

          var failure = function() {
              clear();
              fCb();
          }

          currentErrorHandler = failure;

          script.onerror = failure;
          script.onload = success;
          script.onreadystatechange = function() {
              var state = script.readyState;
              if (state==='loaded' || state==='complete') {
                  success();
              }
          }

          parentNode.appendChild(script);
      }


      // handles script loading error
      // (assuming scripts are loaded one by one in the iframe)
      var currentErrorHandler = function(){};
      window.addEventListener('error', function() {
          currentErrorHandler();
      });


      // window.loadScript(
      //     __jailed__path__ + '_pluginWebIframe.js',
      //     function(){}, function(){}
      // );
      _pluginWebIframe();
  }

  var plugin_mode = getParamValue('type');
  if(plugin_mode =='web-worker'){
    try {
        initWebworkerPlugin();
    } catch(e) {
        // fallback to iframe
        initIframePlugin();
    }
  }
  else if(plugin_mode =='web-python'){
    initWebPythonIframePlugin();
  }
  else if(plugin_mode=='iframe' || plugin_mode=='window'){
    initIframePlugin();
  }
  else{
    console.error("Unsupported plugin type: "+ plugin_mode)
    throw "Unsupported plugin type: "+ plugin_mode
  }

</script>

<script>
function _pluginWebIframe(){


    /**
     * Contains the routines loaded by the plugin iframe under web-browser
     * in case when worker failed to initialize
     *
     * Initializes the web environment version of the platform-dependent
     * connection object for the plugin site
     */


    window.application = {};
    window.connection = {};
    window.api = null;

    // Create a new, plain <span> element
    function _htmlToElement(html) {
        var template = document.createElement('template');
        html = html.trim(); // Never return a text node of whitespace as the result
        template.innerHTML = html;
        return template.content.firstChild;
    }

    var _importScript = function(url) {
        //url is URL of external file, implementationCode is the code
        //to be called from the file, location is the location to
        //insert the <script> element
        return new Promise((resolve, reject) => {
            var scriptTag = document.createElement('script');
            scriptTag.src = url;
            scriptTag.onload = resolve;
            scriptTag.onreadystatechange = resolve;
            scriptTag.onerror = reject;
            document.head.appendChild(scriptTag);
        })
    };

    // support importScripts outside web worker

    async function importScripts () {
      var args = Array.prototype.slice.call(arguments), len = args.length, i = 0;
      for (; i < len; i++) {
        await _importScript(args[i])
      }
    }



    // event listener for the plugin message
    window.addEventListener('message', function(e) {
        var m = e.data.data;
        switch (m.type) {
        case 'import':
        case 'importJailed':  // already jailed in the iframe
            importScript(m.url);
            break;
        case 'execute':
            execute(m.code);
            break;
        case 'message':
            conn._messageHandler(m.data);
            break;
        }
    });


    // loads and executes the javascript file with the given url
    var importScript = function(url) {
        var success = function() {
            parent.postMessage({
                type : 'importSuccess',
                url  : url
            }, '*');
        }

        var failure = function() {
           parent.postMessage({
               type : 'importFailure',
               url  : url
           }, '*');
        }

        var error = null;
        try {
            window.loadScript(url, success, failure);
        } catch (e) {
            error = e;
        }

        if (error) {
            failure();
            throw error;
        }
    }


    // evaluates the provided string
    var execute = async function(code) {
        if(code.type == 'script'){
          if(code.src){
            var script_node = document.createElement('script');
            script_node.setAttribute('src', code.src);
            document.head.appendChild(script_node);
          }
          else{
            if(code.content){
              // document.addEventListener("DOMContentLoaded", function(){
              try {
                  if(code.requirements && (Array.isArray(code.requirements) || typeof code.requirements === 'string') ){
                    try {
                      var link_node;
                      if(Array.isArray(code.requirements)){
                        for(var i=0;i<code.requirements.length;i++){
                          if(code.requirements[i].toLowerCase().endsWith('.css') || code.requirements[i].startsWith('css:')){
                            if(code.requirements[i].startsWith('css:')){
                              code.requirements[i] = code.requirements[i].slice(4)
                            }
                            link_node = document.createElement('link');
                            link_node.rel = 'stylesheet'
                            link_node.href = code.requirements[i]
                            document.head.appendChild(link_node)
                          }
                          else{
                            if(code.requirements[i].startsWith('js:')){
                              code.requirements[i] = code.requirements[i].slice(3)
                            }
                            await importScripts(code.requirements[i])
                          }
                        }
                      }
                      else{
                        if(code.requirements.toLowerCase().endsWith('.css') || code.requirements.startsWith('css:')){
                          if(code.requirements.startsWith('css:')){
                            code.requirements = code.requirements.slice(4)
                          }
                          link_node = document.createElement('link');
                          link_node.rel = 'stylesheet'
                          link_node.href = code.requirements
                          document.head.appendChild(link_node)
                        }
                        else{
                          if(code.requirements.startsWith('js:')){
                            code.requirements = code.requirements.slice(3)
                          }
                          await importScripts(code.requirements)
                        }
                      }
                    } catch (e) {
                      throw "failed to import required scripts: " + code.requirements.toString()
                    }
                  }
                  eval(code.content);
                  if(code.main)  parent.postMessage({type : 'executeSuccess'}, '*');
              } catch (e) {
                  console.error(e.message, e.stack)
                  parent.postMessage({type : 'executeFailure', error: e.toString()}, '*');
                  throw e;
              }
              // });
            }
          }
        }
        else if (code.type == 'style'){
            var style_node = document.createElement('style');
            if(code.src){
              style_node.src = code.src
            }
            style_node.innerHTML = code.content;
            document.head.appendChild(style_node)
        }
        else if (code.type == 'link'){
            var link_node_ = document.createElement('link');
            if(code.rel){
              link_node_.rel = code.rel
            }
            if(code.href){
              link_node_.href = code.href
            }
            if(code.type_){
              link_node_.type = code.type_
            }
            document.head.appendChild(link_node_)
        }
        else if (code.type == 'html'){
             document.body.appendChild(_htmlToElement(code.content));
        }
        else{
          throw "unsupported code type."
        }

    }


    // connection object for the JailedSite constructor
    var conn = {
        disconnect : function() {},
        send: function(data, transferables) {
            parent.postMessage({type: 'message', data: data}, '*', transferables);
        },
        onMessage: function(h){ conn._messageHandler = h },
        _messageHandler: function(){},
        onDisconnect: function(){}
    };

    window.connection = conn;

    parent.postMessage({
        type : 'initialized',
        dedicatedThread : false
    }, '*');
}
</script>

<script>
function _pluginWebPython(){
  /**
   * Contains the routines loaded by the plugin iframe under web-browser
   * in case when worker failed to initialize
   *
   * Initializes the web environment version of the platform-dependent
   * connection object for the plugin site
   */

  /*global api pyodide languagePluginLoader*/
  window.application = {};
  window.connection = {};
  window.api = null;

  // Create a new, plain <span> element
  function _htmlToElement(html) {
      var template = document.createElement('template');
      html = html.trim(); // Never return a text node of whitespace as the result
      template.innerHTML = html;
      return template.content.firstChild;
  }

  var _importScript = function(url) {
      //url is URL of external file, implementationCode is the code
      //to be called from the file, location is the location to
      //insert the <script> element
      return new Promise((resolve, reject) => {
          var scriptTag = document.createElement('script');
          scriptTag.src = url;
          scriptTag.onload = resolve;
          scriptTag.onreadystatechange = resolve;
          scriptTag.onerror = reject;
          document.head.appendChild(scriptTag);
      })
  };

  // support importScripts outside web worker

  async function importScripts () {
    var args = Array.prototype.slice.call(arguments), len = args.length, i = 0;
    for (; i < len; i++) {
      await _importScript(args[i])
    }
  }


  // event listener for the plugin message
  window.addEventListener('message', function(e) {
      var m = e.data.data;
      switch (m.type) {
      case 'import':
      case 'importJailed':  // already jailed in the iframe
          importScript(m.url);
          break;
      case 'execute':
          execute(m.code);
          break;
      case 'message':
          conn._messageHandler(m.data);
          break;
      }
  });


  // loads and executes the javascript file with the given url
  var importScript = function(url) {
      var success = function() {
          parent.postMessage({
              type : 'importSuccess',
              url  : url
          }, '*');
      }

      var failure = function() {
         parent.postMessage({
             type : 'importFailure',
             url  : url
         }, '*');
      }

      var error = null;
      try {
          window.loadScript(url, success, failure);
      } catch (e) {
          error = e;
      }

      if (error) {
          failure();
          throw error;
      }
  }


  var _export_plugin_api = null;
  var execute_python_code = function(code) {
    try {
        if(!_export_plugin_api){
          _export_plugin_api = api.export
          api.export = function(p){
            const getattr = pyodide.pyimport('getattr')
            const hasattr = pyodide.pyimport('hasattr')
            const _api = {}
            for(let k of Object.getOwnPropertyNames(p)){
              if(!k.startsWith('_') && hasattr(p, k)){
                const func = getattr(p, k)
                _api[k] = function(){
                  return func(...Array.prototype.slice.call(arguments))
                }
              }
            }
            _export_plugin_api(_api)
          }
        }
        pyodide.runPython('from js import api')
        pyodide.runPython(code.content)
        if(code.main)  parent.postMessage({type : 'executeSuccess'}, '*');
    } catch (e) {
        console.error(e.message, e.stack)
        parent.postMessage({type : 'executeFailure', error: e.toString()}, '*');
        throw e;
    }
  }
  // evaluates the provided string
  var execute = function(code) {
      if(code.type == 'script'){
        if(code.src){
          var script_node = document.createElement('script');
          script_node.setAttribute('src', code.src);
          document.head.appendChild(script_node);
        }
        else{
          if(code.content){
            if(code.requirements && (Array.isArray(code.requirements) || typeof code.requirements === 'string') ){
              pyodide.loadPackage(code.requirements).then(()=>{
                execute_python_code(code)
              }).catch(()=>{
                var e = "failed to load packages: " + code.requirements.toString()
                parent.postMessage({type : 'executeFailure', error: e}, '*');
                throw e;
              })
            }
            else{
              execute_python_code(code)
            }
          }
        }
      }
      else if (code.type == 'style'){
          var style_node = document.createElement('style');
          if(code.src){
            style_node.src = code.src
          }
          style_node.innerHTML = code.content;
          document.head.appendChild(style_node)
      }
      else if (code.type == 'link'){
          var link_node = document.createElement('link');
          if(code.rel){
            link_node.rel = code.rel
          }
          if(code.href){
            link_node.href = code.href
          }
          if(code.type_){
            link_node.type = code.type_
          }
          document.head.appendChild(link_node)
      }
      else if (code.type == 'html'){
           document.body.appendChild(_htmlToElement(code.content));
      }
      else{
        throw "unsupported code type."
      }

  }


  // connection object for the JailedSite constructor
  var conn = {
      disconnect : function() {},
      send: function(data, transferables) {
          parent.postMessage({type: 'message', data: data}, '*', transferables);
      },
      onMessage: function(h){ conn._messageHandler = h },
      _messageHandler: function(){},
      onDisconnect: function(){}
  };

  window.connection = conn;
  window.languagePluginUrl = 'https://static.imjoy.io/pyodide/';

  importScripts('https://static.imjoy.io/pyodide/pyodide.js').then(()=>{
    languagePluginLoader.then(() => {
        // pyodide is now ready to use...
        console.log(pyodide.runPython('import sys\nsys.version'));
        parent.postMessage({
            type : 'initialized',
            dedicatedThread : false
        }, '*');
    });
  })
}
</script>
